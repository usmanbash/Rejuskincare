{% if settings.collection_handle %}
<div class="upsell_wrapper">
  <div class="h-stack justify-between gap-4 top_upsell_heading">
    <p>Complete your routine, get results faster</p>
    <div class="cart-drawer__upsells_controls h-stack gap-2 sm:flex">
      <button
        is="prev-button"
        class="circle-chevron hover:colors"
        aria-controls="cart-drawer-upsells"
        aria-label="Previous"
      >
        <svg role="presentation" focusable="false" width="5" height="8" class="icon icon-chevron-left-small reverse-icon" viewBox="0 0 5 8">
          <path d="m4.25 7-3-3 3-3" fill="none" stroke="currentColor" stroke-width="1.5"></path>
        </svg>
      </button>
      <button
        is="next-button"
        class="circle-chevron hover:colors"
        aria-controls="cart-drawer-upsells"
        aria-label="Next"
      >
        <svg role="presentation" focusable="false" width="5" height="8" class="icon icon-chevron-right-small reverse-icon" viewBox="0 0 5 8">
          <path d="m.75 7 3-3-3-3" fill="none" stroke="currentColor" stroke-width="1.5"></path>
        </svg>
      </button>
    </div>
  </div>

  <div class="upsell_slider">
    {% assign gift_collection = collections[settings.collection_handle] %}

    {% if gift_collection and gift_collection.products.size > 0 %}
      {% for gift in gift_collection.products %}
        {% assign gift_in_cart = false %}
        {% for item in cart.items %}
          {% if item.product_id == gift.id %}
            {% assign gift_in_cart = true %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% unless gift_in_cart %}
          <div class="flex_box" {% if cart == empty %}style="display:none;"{% endif %}>
            <img class="gift_featured_image" src="{{ gift.featured_image | img_url: '180x' }}" alt="{{ gift.title }}">
            <div class="flex_box_cont">
              <div class="upsell__info">
                <h3 class="gift_title">{{ gift.title }}</h3>
                <span class="gift_price">
                  {% if gift.compare_at_price > gift.price %}
                    <s>{{ gift.compare_at_price | money }}</s>
                  {% endif %}
                  {{ gift.price | money }}
                </span>
              </div>

              <div class="optionss">
                <select class="variant_select">
                  {% for variant in gift.variants %}
                    <option value="{{ variant.id }}" {% unless variant.available %}disabled{% endunless %}>
                      {{ variant.title }} 
                      {% unless variant.available %}(Sold Out){% endunless %}
                    </option>
                  {% endfor %}
                </select>
                <button class="add_cart">Add</button>
              </div>
            </div>
          </div>
        {% endunless %}
      {% endfor %}
    {% else %}
      <p>No products found in gift collection.</p>
    {% endif %}
  </div>
</div>
{% endif %}
<script>
    $(document).ready(function () {
        $(".drawer__inner_box").load(location.href + " .drawer__inner_box", function () {
          console.log("Cart updated successfully.");
        }); 
        $(document).on("click", ".drawer___close-btn", function () {
            $('cart-drawer#CartDrawer .fixed-overlay').click();
        }); 
  // Slider controls
  $(document).on("click", "[is='next-button']", function () {
    const $slider = $(this).closest(".upsell_wrapper").find(".upsell_slider");
    $slider.animate({ scrollLeft: $slider.scrollLeft() + $slider.width() }, 300);
  });

  $(document).on("click", "[is='prev-button']", function () {
    const $slider = $(this).closest(".upsell_wrapper").find(".upsell_slider");
    $slider.animate({ scrollLeft: $slider.scrollLeft() - $slider.width() }, 300);
  });

  // Add to cart with selected variant
  $(document).on('click', '.add_cart', function () {
    const $wrapper = $(this).closest('.flex_box');
    const productId = $wrapper.find('.variant_select').val();

    if (!productId) {
      alert('Please select a variant.');
      return;
    }

    $.post('/cart/add.js', { id: productId, quantity: 1 })
      .done(function () {
        console.log('Gift product added to cart.');
         $(".drawer__inner_box").load(location.href + " .drawer__inner_box", function () {
          console.log("Cart updated successfully.");
        }); 
      })
      .fail(function () {
        console.error('Failed to add gift product.');
      });
  });

});

</script>
    <style>
        /* =======================
   Upsell Styles
======================= */
.upsell_wrapper {
  position: relative;
  padding-inline: 0px;
}

.upsell_slider {
  display: flex;
  overflow-x: hidden;
  gap: 0;
}

/* =======================
   Flex Box Layout
======================= */
.flex_box {
  display: grid;
  grid-template-columns: 90px 1fr;
  align-items: center;
  gap: 15px;
  width: 100%;
  min-width: 100%;
  margin-inline: auto;
  margin-bottom: 10px;
  padding: 15px;
  background-color: #f6f6f7;
  border-radius: 0;
}

.flex_box img {
  width: 100%;
}

.flex_box h3 {
  margin: 0 0 4px;
  font-size: 13px;
  display: -webkit-box;
  -webkit-line-clamp: 1; /* clamp to 1 line */
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Two-line clamp in free upsell */
.free_upsell .flex_box h3 {
  -webkit-line-clamp: 2;
}

span.gift_price {
  display: block;
}

/* =======================
   Buttons
======================= */
button.add_cart {
  display: block;
  min-width: auto;
  width: 100%;
  padding: 10px 20px;
  border: 0;
  cursor: pointer;
  background: #44ac52;
  color: #fff;
  font-size: 12px;
  font-weight: 700;
  font-family: 'Inter', sans-serif;
  text-transform: math-auto !important;
  line-height: 1;
  height: auto;
}

.free_upsell button.add_cart {
  width: 115px;
}

/* =======================
   Top Upsell Heading
======================= */
.top_upsell_heading {
  display: flex;
  align-items: center;
  justify-content: center;
  color: black;
  font-weight: 500;
  font-family: 'Inter', sans-serif;
}

.top_upsell_heading button {
  position: absolute;
  top: 60%;
  right: -15px;
  width: auto;
  height: auto;
  padding: 0;
  border: none;
  border-radius: 30px;
  background: transparent;
  color: black;
  opacity: 1;
  font-weight: 300;
  cursor: pointer;
}

.top_upsell_heading button[is="prev-button"] {
  left: -15px;
  right: auto;
}

.top_upsell_heading button svg {
  width: 14px;
  height: 14px;
}

/* =======================
   Flex Box Container
======================= */
.flex_box_cont {
  display: flex;
  flex-direction: column;
}

p.horizontal-product__off.text-sm {
  margin: 0;
}

cart-drawer-items {
  display: flex;
  flex-direction: column;
}
.optionss {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}
.flex_box select {
    outline: none !important;
    min-width: 46%;
}
.cart-drawer__footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    background: #f6f6f7;
    padding: 23px;
    border-top: 1px solid rgba(0, 0, 0, .1);
}
span.free-shipping-goal__label {
    text-align: center;
}
.drawer{
  z-index: 99999;
}
</style>
  
